<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PestPost • Admin (Ultra‑Lite, Clean)</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <style>
    body{margin:0;padding:16px;background:#0f1115;color:#eaeaea;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    h1{margin:0 0 10px;font-size:18px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
    input{background:#0e1016;color:#eaeaea;border:1px solid #222;border-radius:8px;padding:8px 10px;min-width:320px}
    button{background:#7c5cff;border:none;border-radius:8px;color:#fff;padding:8px 12px;cursor:pointer}
    button.secondary{background:#1e2230}
    button.ghost{background:transparent;border:1px solid #333;color:#cfd8e3}
    #status{color:#9aa4b2}
    .box{border:1px solid #222;border-radius:10px;padding:12px;margin-top:12px;background:#151821}
    .log{white-space:pre-wrap;background:#0d1018;border:1px solid #222;border-radius:8px;padding:8px;max-height:220px;overflow:auto;margin-top:8px}
    .card{border:1px solid #222;border-radius:10px;padding:10px;margin:10px 0;background:#121520}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .muted{color:#9aa4b2}
    .hidden{display:none}
  </style>
</head>
<body>
  <h1>PestPost • Admin</h1>
  <div class="row">
    <label for="token" class="muted">ADMIN_API_TOKEN</label>
    <input id="token" type="password" placeholder="Paste your admin token" />
    <button onclick="saveToken()">Save</button>
    <button class="secondary" onclick="clearToken()">Clear</button>
    <div id="status" class="muted"></div>
    <div style="margin-left:auto" class="row">
      <button class="ghost" id="toggleLogBtn" onclick="toggleLog()">Show log</button>
      <button onclick="loadDrafts()">Refresh drafts</button>
      <div class="muted">Host: <span id="host"></span></div>
    </div>
  </div>

  <div class="box hidden" id="logBox">
    <strong>Log</strong>
    <div id="log" class="log"></div>
  </div>

  <div class="box">
    <strong>Drafts</strong>
    <div id="drafts"></div>
  </div>

<script>
  // ===== Utilities =====
  const TOKEN_KEY = 'pp_admin_token';
  const logEl = document.getElementById('log');
  const logBox = document.getElementById('logBox');
  const draftsEl = document.getElementById('drafts');
  function log(msg){ if(!logEl) return; const t = new Date().toLocaleTimeString(); logEl.textContent += `\n[${t}] ${msg}`; logEl.scrollTop = logEl.scrollHeight; }
  function toggleLog(){ logBox.classList.toggle('hidden'); document.getElementById('toggleLogBtn').textContent = logBox.classList.contains('hidden')? 'Show log':'Hide log'; }
  function getToken(){ return localStorage.getItem(TOKEN_KEY) || ''; }
  function setToken(v){ localStorage.setItem(TOKEN_KEY, v); }
  function updateStatus(){ const t = getToken(); document.getElementById('status').textContent = t? `Saved (len=${t.length})` : 'No token saved'; }

  // Global error surfacer
  window.addEventListener('error', e=> { log('JS error: '+(e.message||'Unknown')); });
  window.addEventListener('unhandledrejection', e=> { log('Promise error: '+((e&&e.reason&&e.reason.message)||String(e.reason||e))); });

  // Buttons
  function saveToken(){ const v = document.getElementById('token').value.trim(); if(!v){ log('Enter a token first'); return; } setToken(v); updateStatus(); log('Token saved.'); }
  function clearToken(){ localStorage.removeItem(TOKEN_KEY); updateStatus(); log('Token cleared.'); }

  async function apiFetch(path, opts={}){
    const token = getToken(); if(!token) throw new Error('Missing ADMIN_API_TOKEN — paste and Save first.');
    const headers = new Headers(opts.headers||{}); headers.set('Authorization','Bearer '+token);
    let res = await fetch(path, Object.assign({}, opts, {headers}));
    if(res.status===401||res.status===403){ const url=new URL(path, location.origin); url.searchParams.set('token', token); res = await fetch(url.toString(), Object.assign({}, opts)); }
    if(!res.ok){ const txt = await res.text(); throw new Error('HTTP '+res.status+' — '+txt); }
    const ct = res.headers.get('content-type')||''; return ct.includes('application/json') ? res.json() : res.text();
  }

  async function loadDrafts(){
    draftsEl.innerHTML = '<div class="muted">Loading…</div>';
    try{
      const data = await apiFetch('/api/admin-drafts?limit=50');
      const items = data.items || data || [];
      log('Loaded drafts: '+items.length);
      if(items.length===0){ draftsEl.innerHTML = '<div class="muted">No drafts.</div>'; return; }
      draftsEl.innerHTML = items.map(it=> renderDraft(it)).join('');
    }catch(e){
      log('loadDrafts error: '+e.message);
      draftsEl.innerHTML = '<div class="muted">Error: '+(e.message||e)+'</div>';
    }
  }

  function renderDraft(it){
    const id = Number(it.id)||'';
    const mpath = it.media_path || (it.media && it.media.storage_path) || '';
    const status = (it.status||'draft').toLowerCase();
    return `<div class="card">
      <div><strong>#${id}</strong> • <span class="muted">${new Date(it.created_at).toLocaleString()}</span> • <span>${status}</span></div>
      ${it.text_body? `<div><span class='muted'>text:</span> ${escapeHtml(it.text_body)}</div>`:''}
      ${it.caption_seed? `<div><span class='muted'>seed:</span> ${escapeHtml(it.caption_seed)}</div>`:''}
      ${mpath? `<div class='mono'><span class='muted'>media:</span> ${escapeHtml(mpath)}</div>`:''}
      <div class="row">
        ${id? `<button ${status==='approved'?'disabled':''} onclick="approve(${id}, this)">${status==='approved'?'Approved':'Approve'}</button>`:''}
        ${id? `<button class="secondary" onclick="sendPreview(${id}, this)">Send preview</button>`:''}
        ${mpath? `<button class="ghost" onclick="openMedia('${encodeURIComponent(mpath)}')">Open media</button>`:''}
      </div>
    </div>`;
  }

  window.approve = async function(id, btn){ try{ btn&& (btn.disabled=true); await apiFetch('/api/admin-approve?id='+encodeURIComponent(id)); log('Approved #'+id); await loadDrafts(); }catch(e){ log('approve error: '+e.message); } finally{ btn&&(btn.disabled=false); } }
  window.sendPreview = async function(id, btn){ try{ btn&& (btn.disabled=true); await apiFetch('/api/admin-send-preview?id='+encodeURIComponent(id)); log('preview ok for #'+id); }catch(e){ log('preview error: '+e.message); } finally{ btn&&(btn.disabled=false); } }
  window.openMedia = async function(storagePathEnc){ const path=decodeURIComponent(storagePathEnc); try{ const data=await apiFetch('/api/admin-media-url?path='+encodeURIComponent(path)); const url=(typeof data==='string')? data : (data.url||data.signed_url||''); if(!url) throw new Error('No URL in response'); window.open(url,'_blank'); }catch(e){ log('openMedia error: '+e.message); } }

  function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

  // Init
  document.getElementById('host').textContent = location.host;
  const saved = getToken(); if(saved){ document.getElementById('token').value = saved; }
  updateStatus();
</script>
</body>
</html>
